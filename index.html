<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Compras</title>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configurações do Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        dark: {
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(14, 165, 233, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Toast Animation */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideInRight 0.3s ease-out forwards; }
        
        /* Table Styles */
        .table-spacing {
            border-collapse: separate;
            border-spacing: 0 8px;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-600 h-screen flex flex-col overflow-hidden">

    <!-- TOAST CONTAINER (MENSAGENS DE ERRO/SUCESSO) -->
    <div id="toast-container" class="fixed top-24 right-6 z-[70] flex flex-col gap-3 pointer-events-none">
        <!-- JS injetará os alertas aqui -->
    </div>

    <!-- TELA DE LOGIN (BLOQUEIO) -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-md text-center transform transition-all scale-100">
            <div class="w-20 h-20 bg-brand-50 text-brand-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-glow">
                <i class="fa-solid fa-lock text-3xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 mb-2">Acesso Restrito</h2>
            <p class="text-slate-500 mb-8">Por favor, identifique-se para continuar.</p>
            
            <form onsubmit="attemptLogin(event)" class="space-y-4">
                <div class="relative">
                    <input type="password" id="login-password" placeholder="Senha de Acesso" class="w-full px-6 py-4 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-4 focus:ring-brand-100 focus:border-brand-500 outline-none text-center font-bold tracking-widest text-xl transition-all placeholder:font-normal placeholder:tracking-normal placeholder:text-slate-400">
                    <i class="fa-solid fa-key absolute right-5 top-5 text-slate-400"></i>
                </div>
                
                <button type="submit" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-brand-500/30 hover:shadow-brand-500/50 hover:-translate-y-0.5 active:translate-y-0 text-lg">
                    Entrar no Sistema
                </button>
            </form>
            
            <p id="login-error" class="text-red-500 text-sm mt-6 hidden font-medium bg-red-50 py-2 rounded-lg border border-red-100 animate-pulse">
                <i class="fa-solid fa-circle-xmark mr-1"></i> Senha incorreta. Tente novamente.
            </p>
            
            <p class="text-slate-300 text-xs mt-8">SysCompras v2.2 • Segurança Ativa</p>
        </div>
    </div>

    <!-- Header Principal -->
    <header class="fixed top-0 w-full bg-white/90 backdrop-blur-md border-b border-gray-200 z-30 flex justify-between items-center px-6 py-3 shadow-sm">
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="w-10 h-10 flex items-center justify-center text-gray-500 hover:text-brand-600 hover:bg-brand-50 rounded-xl transition-all">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
            
            <div class="flex items-center gap-2">
                <div class="bg-brand-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm shadow-glow">
                    <i class="fa-solid fa-boxes-packing"></i>
                </div>
                <span class="font-bold text-slate-800 text-lg tracking-tight">SysCompras <span class="text-xs font-normal text-gray-400 ml-1">Pro</span></span>
            </div>
        </div>

        <div class="flex items-center gap-4">
             <div class="text-right hidden sm:block">
                <p class="text-sm font-bold text-slate-700" id="header-date">--/--/----</p>
                <p class="text-xs text-brand-600 font-medium" id="header-time">00:00</p>
            </div>
            <div class="h-8 w-px bg-gray-200 hidden sm:block"></div>
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-400">
                    <i class="fa-solid fa-user"></i>
                </div>
                <!-- BOTÃO SAIR (LOGOUT) -->
                <button onclick="logout()" class="text-slate-400 hover:text-red-500 hover:bg-red-50 w-9 h-9 rounded-full flex items-center justify-center transition-colors" title="Sair do Sistema">
                    <i class="fa-solid fa-right-from-bracket text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar (Gaveta Deslizante) -->
    <aside id="main-sidebar" class="fixed inset-y-0 left-0 w-72 bg-white border-r border-gray-200 z-40 transform -translate-x-full transition-transform duration-300 shadow-2xl flex flex-col">
        <div class="p-6 flex justify-between items-center border-b border-gray-100 bg-slate-50">
            <h2 class="text-lg font-bold text-slate-700 tracking-tight">Navegação</h2>
            <button onclick="toggleSidebar()" class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-400 hover:text-red-500 hover:border-red-200 transition-colors">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <nav class="flex-1 px-4 space-y-1 mt-6">
            <p class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Gestão</p>
            <button onclick="showPage('dashboard'); toggleSidebar()" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl transition-all duration-200 group text-slate-600 hover:bg-slate-50 border border-transparent">
                <i class="fa-solid fa-chart-pie w-5 group-hover:text-brand-600 transition-colors"></i> <span class="font-medium">Visão Geral</span>
            </button>
            <button onclick="showPage('orders'); toggleSidebar()" id="nav-orders" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl transition-all duration-200 group text-slate-600 hover:bg-slate-50 border border-transparent">
                <i class="fa-solid fa-list-check w-5 group-hover:text-brand-600 transition-colors"></i> <span class="font-medium">Ordens de Compra</span>
            </button>
            <!-- BOTÃO SERVIÇOS NOVO -->
            <button onclick="showPage('services'); toggleSidebar()" id="nav-services" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl transition-all duration-200 group text-slate-600 hover:bg-slate-50 border border-transparent">
                <i class="fa-solid fa-helmet-safety w-5 group-hover:text-brand-600 transition-colors"></i> <span class="font-medium">Prestadores de Serviço</span>
            </button>
            <button onclick="showPage('reminders'); toggleSidebar()" id="nav-reminders" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl transition-all duration-200 group text-slate-600 hover:bg-slate-50 border border-transparent">
                <i class="fa-solid fa-bell w-5 group-hover:text-brand-600 transition-colors"></i> <span class="font-medium">Lembretes</span>
            </button>
            
            <p class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-6">Sistema</p>
            <button onclick="showPage('status'); toggleSidebar()" id="nav-status" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl transition-all duration-200 group text-slate-600 hover:bg-slate-50 border border-transparent">
                <i class="fa-solid fa-tags w-5 group-hover:text-brand-600 transition-colors"></i> <span class="font-medium">Cadastro de Status</span>
            </button>
            <button onclick="showPage('settings'); toggleSidebar()" id="nav-settings" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl transition-all duration-200 group text-slate-600 hover:bg-slate-50 border border-transparent">
                <i class="fa-solid fa-gear w-5 group-hover:text-brand-600 transition-colors"></i> <span class="font-medium">Configurações</span>
            </button>
            <button onclick="logout(); toggleSidebar()" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-left rounded-xl transition-all duration-200 group text-slate-600 hover:bg-red-50 hover:text-red-600 border border-transparent">
                <i class="fa-solid fa-right-from-bracket w-5 group-hover:text-red-600 transition-colors"></i> <span class="font-medium">Sair</span>
            </button>
        </nav>

        <div class="p-4 bg-slate-50 border-t border-gray-200">
            <div class="bg-brand-50 rounded-lg p-3 border border-brand-100">
                <p class="text-xs text-brand-700 font-medium mb-1"><i class="fa-solid fa-circle-info mr-1"></i> Status do Sistema</p>
                <p class="text-[10px] text-brand-600/70">Todos os serviços operacionais.</p>
            </div>
        </div>
    </aside>

    <!-- Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px] z-30 hidden transition-opacity" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto pt-20 pb-8 bg-[#F8FAFC] relative scroll-smooth w-full">
        
        <!-- DASHBOARD PAGE -->
        <div id="page-dashboard" class="px-6 md:px-8 max-w-[1600px] mx-auto fade-in pb-12">
            
            <!-- Welcome Banner & Quick Actions -->
            <div class="relative bg-white rounded-3xl p-8 mb-8 shadow-sm border border-slate-100 overflow-hidden group">
                <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-brand-50 to-brand-100 rounded-full blur-3xl opacity-50 -mr-16 -mt-16 pointer-events-none"></div>
                
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <span class="bg-brand-100 text-brand-700 text-xs font-bold px-2 py-1 rounded-md uppercase tracking-wider">Visão Geral</span>
                            <span class="text-slate-400 text-xs flex items-center gap-1"><i class="fa-regular fa-calendar"></i> <span id="banner-date">Hoje</span></span>
                        </div>
                        <h1 class="text-3xl font-bold text-slate-800 tracking-tight" id="welcome-msg">Painel de Controle</h1>
                        <p class="text-slate-500 mt-1">Acompanhe métricas, prazos e atividades recentes em tempo real.</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="openModal('modal-reminder')" class="flex items-center gap-2 bg-white border border-slate-200 text-slate-600 hover:text-brand-600 hover:border-brand-200 px-5 py-3 rounded-xl text-sm font-semibold transition-all shadow-sm hover:shadow-md group">
                            <i class="fa-regular fa-bell text-slate-400 group-hover:text-brand-500 transition-colors"></i>
                            <span>Lembrete</span>
                        </button>
                        <button onclick="newOrder()" class="flex items-center gap-2 bg-slate-900 hover:bg-slate-800 text-white px-6 py-3 rounded-xl text-sm font-semibold transition-all shadow-lg shadow-slate-200 hover:shadow-xl hover:-translate-y-0.5">
                            <div class="w-5 h-5 rounded-full bg-white/20 flex items-center justify-center text-[10px]"><i class="fa-solid fa-plus"></i></div>
                            <span>Nova Ordem</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dynamic KPI Grid -->
            <div id="kpi-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- JS Populated -->
            </div>

            <!-- Main Complex Grid -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                
                <!-- Coluna Esquerda (Principal) -->
                <div id="col-main" class="xl:col-span-2 space-y-8 min-h-[200px]">
                    
                    <!-- Próximas Entregas (Detailed List) -->
                    <div id="widget-upcoming" class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="px-8 py-6 border-b border-slate-50 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="bg-brand-50 text-brand-600 w-10 h-10 rounded-xl flex items-center justify-center">
                                    <i class="fa-solid fa-truck-fast"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800">Próximas Entregas</h3>
                                    <p class="text-xs text-slate-400">Previsão para os próximos 7 dias</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <button onclick="showPage('orders')" class="text-sm font-medium text-slate-500 hover:text-brand-600 transition-colors hidden sm:block">Ver todas <i class="fa-solid fa-arrow-right ml-1 text-xs"></i></button>
                            </div>
                        </div>
                        
                        <div class="p-0">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50/50 text-xs uppercase text-slate-400 font-semibold border-b border-slate-50">
                                    <tr>
                                        <th class="px-8 py-4 pl-8">Data Prevista</th>
                                        <th class="px-8 py-4">Detalhes do Pedido</th>
                                        <th class="px-8 py-4 text-right hidden sm:table-cell">Setor</th>
                                    </tr>
                                </thead>
                                <tbody id="upcoming-deliveries-body" class="divide-y divide-slate-50 text-sm">
                                    <!-- JS Filled -->
                                </tbody>
                            </table>
                            <div id="upcoming-empty" class="hidden py-12 flex flex-col items-center justify-center text-slate-400">
                                <i class="fa-regular fa-calendar-xmark text-4xl mb-3 opacity-30"></i>
                                <p>Sem entregas agendadas para esta semana.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Section -->
                    <div id="widget-chart" class="bg-white rounded-3xl shadow-sm border border-slate-100 p-8">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">Análise de Distribuição</h3>
                                <p class="text-sm text-slate-400">Visualização gráfica do status das ordens.</p>
                            </div>
                        </div>
                        <!-- Container com altura fixa para o gráfico -->
                        <div class="w-full h-80 relative">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>

                </div>

                <!-- Coluna Direita (Lateral) -->
                <div id="col-side" class="space-y-8 min-h-[200px]">
                    
                    <!-- Lembretes Widget -->
                    <div id="widget-reminders" class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden flex flex-col min-h-[420px]">
                        <div class="p-6 border-b border-slate-50 bg-slate-50/30 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <i class="fa-solid fa-thumbtack text-purple-500 transform rotate-45"></i> Quadro de Avisos
                            </h3>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold bg-purple-100 text-purple-600 px-2 py-1 rounded-full" id="reminders-count-badge">0</span>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="dashboard-reminders-list">
                            <!-- Filled by JS -->
                        </div>
                        <div class="p-4 border-t border-slate-50 bg-slate-50/30">
                            <button onclick="openModal('modal-reminder')" class="w-full py-2.5 rounded-xl border border-dashed border-slate-300 text-slate-500 text-sm font-medium hover:border-purple-300 hover:text-purple-600 hover:bg-purple-50 transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-plus"></i> Adicionar Nota Rápida
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- ORDERS PAGE -->
        <div id="page-orders" class="px-6 md:px-8 max-w-[1600px] mx-auto hidden fade-in">
            <header class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-6 mt-4">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Ordens de Compra</h2>
                    <p class="text-slate-500 mt-1">Gerencie suas requisições e prazos.</p>
                </div>
                <button onclick="newOrder()" class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-xl shadow-lg shadow-slate-200 hover:shadow-xl transition-all flex items-center gap-2 font-medium">
                    <i class="fa-solid fa-plus"></i> Nova Ordem
                </button>
            </header>

            <!-- Modern Filters -->
            <div class="bg-white p-2 rounded-xl border border-slate-200 shadow-sm mb-6 flex flex-col md:flex-row gap-2">
                <div class="flex-1 relative">
                    <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-400"></i>
                    <input type="text" id="search-order" onkeyup="filterOrders()" placeholder="Buscar fornecedor, produto, setor..." class="w-full pl-11 pr-4 py-3 rounded-lg border-none focus:ring-0 text-slate-700 placeholder-slate-400 font-medium bg-transparent">
                </div>
                <div class="h-auto w-px bg-slate-200 hidden md:block my-2"></div>
                <select id="filter-status" onchange="filterOrders()" class="p-3 px-4 rounded-lg border-none focus:ring-0 bg-transparent font-medium text-slate-600 cursor-pointer hover:bg-slate-50 transition-colors">
                    <!-- JS Filled -->
                </select>
            </div>

            <!-- Desktop View (Table) -->
            <div class="hidden md:block overflow-x-auto pb-4">
                <table class="w-full table-spacing">
                    <thead>
                        <tr class="text-xs uppercase text-slate-400 font-bold tracking-wider text-center">
                            <th class="pb-4 pl-6">Ordem</th>
                            <th class="pb-4">Fornecedor</th>
                            <th class="pb-4">Setor</th>
                            <th class="pb-4">Produto</th>
                            <th class="pb-4">Entrega</th>
                            <th class="pb-4">Status</th>
                            <th class="pb-4 pr-6 text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="orders-desktop-body" class="text-sm">
                        <!-- JS Generated -->
                    </tbody>
                </table>
            </div>

            <!-- Mobile View (Cards) -->
            <div class="md:hidden grid grid-cols-1 gap-4 pb-4" id="orders-mobile-grid">
                <!-- JS Generated -->
            </div>

            <div id="empty-state" class="hidden py-16 text-center">
                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300">
                    <i class="fa-solid fa-search text-3xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Nenhum resultado</h3>
                <p class="text-slate-500">Tente ajustar seus filtros de busca.</p>
            </div>
        </div>

        <!-- NEW: SERVICES PAGE -->
        <div id="page-services" class="px-6 md:px-8 max-w-[1600px] mx-auto hidden fade-in">
            <header class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-6 mt-4">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Gestão de Serviços</h2>
                    <p class="text-slate-500 mt-1">Organize os serviços realizados por prestadores.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="printServices()" class="bg-white border border-slate-200 text-slate-600 hover:text-brand-600 hover:border-brand-200 px-6 py-3 rounded-xl shadow-sm hover:shadow-md transition-all flex items-center gap-2 font-medium">
                        <i class="fa-solid fa-print"></i> Imprimir
                    </button>
                    <button onclick="newService()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-3 rounded-xl shadow-lg shadow-brand-500/30 hover:shadow-brand-500/50 transition-all flex items-center gap-2 font-medium">
                        <i class="fa-solid fa-plus"></i> Novo Serviço
                    </button>
                </div>
            </header>

            <!-- SERVICES DASHBOARD -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="services-dashboard">
                <!-- JS Populated -->
            </div>

            <!-- Modern Filters for Services -->
            <div class="bg-white p-2 rounded-xl border border-slate-200 shadow-sm mb-6 flex flex-col md:flex-row gap-2">
                <div class="flex-1 relative">
                    <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-400"></i>
                    <input type="text" id="search-service" onkeyup="renderServices()" placeholder="Buscar prestador, tipo de serviço..." class="w-full pl-11 pr-4 py-3 rounded-lg border-none focus:ring-0 text-slate-700 placeholder-slate-400 font-medium bg-transparent">
                </div>
                <div class="h-auto w-px bg-slate-200 hidden md:block my-2"></div>
                <input type="date" id="filter-service-date" onchange="renderServices()" class="p-3 px-4 rounded-lg border-none focus:ring-0 bg-transparent font-medium text-slate-600 cursor-pointer hover:bg-slate-50 transition-colors">
                
                <div class="h-auto w-px bg-slate-200 hidden md:block my-2"></div>
                <select id="filter-service-status" onchange="renderServices()" class="p-3 px-4 rounded-lg border-none focus:ring-0 bg-transparent font-medium text-slate-600 cursor-pointer hover:bg-slate-50 transition-colors">
                    <option value="all">Todos os Status</option>
                    <option value="concluido">Concluído</option>
                    <option value="pendente">Pendente</option>
                    <option value="agendado">Agendado</option>
                </select>
            </div>

            <!-- Service Cards Grid -->
            <div id="services-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-8">
                <!-- JS Generated -->
            </div>
            
            <div id="services-empty-state" class="hidden py-16 text-center">
                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300">
                    <i class="fa-solid fa-helmet-safety text-3xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Nenhum serviço encontrado</h3>
                <p class="text-slate-500">Adicione um novo serviço para começar.</p>
            </div>
        </div>

        <!-- REMINDERS PAGE -->
        <div id="page-reminders" class="px-6 md:px-8 max-w-[1600px] mx-auto hidden fade-in">
            <header class="mb-10 flex justify-between items-center mt-4">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Lembretes</h2>
                    <p class="text-slate-500 mt-1">Tarefas e prazos importantes.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="requestNotificationPermission()" class="w-12 h-12 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center justify-center transition-colors shadow-sm group relative" title="Ativar Alertas">
                        <i class="fa-solid fa-bell text-xl"></i>
                        <span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden" id="notification-dot"></span>
                    </button>
                    <button onclick="openModal('modal-reminder')" class="w-12 h-12 rounded-xl bg-purple-100 text-purple-600 hover:bg-purple-200 flex items-center justify-center transition-colors shadow-sm">
                        <i class="fa-solid fa-plus text-xl"></i>
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="reminders-grid">
                <!-- JS Generated -->
            </div>
            
            <div id="reminders-empty" class="hidden flex flex-col items-center justify-center py-20 opacity-50">
                 <i class="fa-solid fa-clipboard-check text-6xl text-slate-300 mb-4"></i>
                 <p class="text-slate-500 font-medium">Tudo limpo por aqui!</p>
            </div>
        </div>

        <!-- STATUS PAGE (NOVO) -->
        <div id="page-status" class="px-6 md:px-8 max-w-[1600px] mx-auto hidden fade-in">
            <header class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-6 mt-4">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Cadastro de Status</h2>
                    <p class="text-slate-500 mt-1">Personalize os estados das suas ordens.</p>
                </div>
                <!-- CHANGED onclick to newStatus() -->
                <button onclick="newStatus()" class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-xl shadow-lg shadow-slate-200 hover:shadow-xl transition-all flex items-center gap-2 font-medium">
                    <i class="fa-solid fa-plus"></i> Novo Status
                </button>
            </header>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-xs uppercase text-slate-400 font-semibold">
                        <tr>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4 text-center">Cor</th>
                            <th class="px-6 py-4 text-center">Ícone</th>
                            <th class="px-6 py-4 text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="status-table-body" class="divide-y divide-slate-100">
                        <!-- JS Filled -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SETTINGS PAGE -->
        <div id="page-settings" class="px-6 md:px-8 max-w-4xl mx-auto hidden fade-in">
            <header class="mb-10 mt-4">
                <h2 class="text-3xl font-bold text-slate-800">Configurações</h2>
                <p class="text-slate-500 mt-1">Gerencie seus dados e preferências do sistema.</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Backup Card -->
                <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm flex flex-col items-center text-center">
                    <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mb-6">
                        <i class="fa-solid fa-cloud-arrow-down text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Fazer Backup</h3>
                    <p class="text-slate-500 text-sm mb-8 flex-1">Exporte todos os seus dados (Ordens e Lembretes) para um arquivo seguro. Recomendado semanalmente.</p>
                    <button onclick="exportData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-xl transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-download"></i> Exportar Dados
                    </button>
                </div>

                <!-- Restore Card -->
                <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm flex flex-col items-center text-center">
                    <div class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center mb-6">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Restaurar Dados</h3>
                    <p class="text-slate-500 text-sm mb-8 flex-1">Recupere seus dados a partir de um arquivo de backup (.json). Isso substituirá os dados atuais.</p>
                    <label class="w-full cursor-pointer bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 px-6 rounded-xl transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-upload"></i> Selecionar Arquivo
                        <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                    </label>
                </div>
            </div>
        </div>

    </main>

    <!-- MODAL SERVICE (NOVO) -->
    <div id="modal-service" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-brand-50">
                <h3 id="modal-service-title" class="font-bold text-xl text-brand-900">Novo Serviço</h3>
                <button onclick="closeModal('modal-service')" class="w-8 h-8 rounded-full hover:bg-white flex items-center justify-center text-brand-700 transition-colors"><i class="fa-solid fa-times"></i></button>
            </div>
            <form id="form-service" onsubmit="saveService(event)" class="p-8 space-y-5">
                <input type="hidden" id="service-id">
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Prestador</label>
                    <input type="text" id="service-provider" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all font-medium">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tipo de Serviço</label>
                    <input type="text" id="service-type" placeholder="Ex: Manutenção" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all font-medium">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Data de Realização</label>
                        <input type="date" id="service-date" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all font-medium text-slate-600">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Data do Relatório</label>
                        <input type="date" id="service-report-date" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all font-medium text-slate-600">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Status</label>
                    <select id="service-status" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all font-medium appearance-none">
                        <option value="agendado">Agendado</option>
                        <option value="pendente">Pendente</option>
                        <option value="concluido">Concluído</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Descrição</label>
                    <textarea id="service-desc" rows="2" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all font-medium resize-none"></textarea>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t border-slate-100">
                    <button type="button" onclick="closeModal('modal-service')" class="px-6 py-2.5 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition-colors">Cancelar</button>
                    <button type="submit" class="px-6 py-2.5 bg-brand-600 hover:bg-brand-700 text-white rounded-lg shadow-lg hover:shadow-xl font-medium transition-all">Salvar Serviço</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL STATUS -->
    <div id="modal-status" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-xl text-slate-800">Gerenciar Status</h3>
                <button onclick="closeModal('modal-status')" class="w-8 h-8 rounded-full hover:bg-gray-200 flex items-center justify-center text-slate-500 transition-colors"><i class="fa-solid fa-times"></i></button>
            </div>
            <form id="form-status" onsubmit="saveStatus(event)" class="p-8 space-y-5">
                <input type="hidden" id="status-id">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Nome do Status</label>
                    <input type="text" id="status-label" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all font-medium" placeholder="Ex: Em Análise">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Cor (Tema)</label>
                    <select id="status-color" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all font-medium appearance-none">
                        <option value="slate">Cinza (Padrão)</option>
                        <option value="red">Vermelho (Urgente)</option>
                        <option value="orange">Laranja (Atenção)</option>
                        <option value="amber">Amarelo (Aguardando)</option>
                        <option value="green">Verde (Sucesso)</option>
                        <option value="emerald">Esmeralda (Entregue)</option>
                        <option value="teal">Verde Água</option>
                        <option value="cyan">Ciano</option>
                        <option value="sky">Azul Céu</option>
                        <option value="blue">Azul</option>
                        <option value="indigo">Índigo (Assinatura)</option>
                        <option value="violet">Violeta</option>
                        <option value="purple">Roxo</option>
                        <option value="fuchsia">Fúcsia</option>
                        <option value="pink">Rosa</option>
                        <option value="rose">Rosé</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Ícone (FontAwesome)</label>
                    <select id="status-icon" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all font-medium appearance-none">
                        <option value="fa-circle">Círculo (Padrão)</option>
                        <option value="fa-clock">Relógio</option>
                        <option value="fa-check">Check / Visto</option>
                        <option value="fa-file-signature">Assinatura</option>
                        <option value="fa-truck">Caminhão</option>
                        <option value="fa-box">Caixa</option>
                        <option value="fa-ban">Proibido / Cancelado</option>
                        <option value="fa-triangle-exclamation">Alerta</option>
                        <option value="fa-thumbs-up">Joinha</option>
                        <option value="fa-magnifying-glass">Lupa</option>
                        <option value="fa-user-clock">Usuário Aguardando</option>
                    </select>
                </div>
                <div class="pt-4 flex justify-end gap-3 border-t border-slate-100">
                    <button type="button" onclick="closeModal('modal-status')" class="px-6 py-2.5 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition-colors">Cancelar</button>
                    <button type="submit" class="px-6 py-2.5 bg-brand-600 hover:bg-brand-700 text-white rounded-lg shadow-lg hover:shadow-xl font-medium transition-all">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL REMINDER -->
    <div id="modal-reminder" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="px-8 py-6 border-b border-purple-50 bg-purple-50/50 flex justify-between items-center">
                <h3 class="font-bold text-xl text-purple-900">Novo Lembrete</h3>
                <button onclick="closeModal('modal-reminder')" class="text-purple-800/50 hover:text-purple-800 transition-colors"><i class="fa-solid fa-times"></i></button>
            </div>
            <form id="form-reminder" onsubmit="saveReminder(event)" class="p-8 space-y-5">
                <div>
                    <label class="block text-xs font-bold text-purple-700/70 uppercase tracking-wider mb-2">Nota</label>
                    <textarea id="reminder-text" rows="3" required class="w-full px-4 py-3 bg-purple-50/30 border border-purple-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-purple-400/30 focus:border-purple-400 outline-none transition-all font-medium resize-none placeholder-purple-400/50 text-purple-900" placeholder="Ex: Renovar contrato..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-purple-700/70 uppercase tracking-wider mb-2">Prazo</label>
                    <input type="date" id="reminder-date" class="w-full px-4 py-3 bg-purple-50/30 border border-purple-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-purple-400/30 focus:border-purple-400 outline-none transition-all font-medium text-purple-800">
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('modal-reminder')" class="px-6 py-2.5 text-slate-500 hover:bg-slate-50 rounded-lg font-medium transition-colors">Cancelar</button>
                    <button type="submit" class="px-6 py-2.5 bg-purple-500 hover:bg-purple-400 text-white rounded-lg shadow-lg shadow-purple-500/30 font-medium transition-all">Criar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL DELETE CONFIRMATION -->
    <div id="modal-delete" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden p-8 text-center">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fa-regular fa-trash-can text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Excluir Item?</h3>
            <p class="text-slate-500 text-sm mb-8 leading-relaxed">Você tem certeza que deseja remover este item? Esta ação é irreversível.</p>
            
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal('modal-delete')" class="px-5 py-2.5 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition-colors">Cancelar</button>
                <button onclick="confirmDelete()" class="px-6 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow-lg hover:shadow-red-500/30 font-medium transition-all">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <!-- MODAL NOTIFICATION (NEW) -->
    <div id="modal-notification" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden relative transform scale-100 transition-transform">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-600"></div>
            <div class="p-8 text-center">
                <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
                    <i class="fa-solid fa-truck-fast text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800 mb-2">Entregas Hoje!</h3>
                <p class="text-slate-500 text-sm mb-6">As seguintes ordens estão agendadas para entrega hoje:</p>
                
                <div id="notification-list" class="bg-slate-50 rounded-xl p-4 mb-6 text-left space-y-3 max-h-60 overflow-y-auto border border-slate-100">
                    <!-- JS Injected Content -->
                </div>
                
                <button onclick="closeModal('modal-notification')" class="w-full py-3 bg-slate-900 hover:bg-slate-800 text-white rounded-xl font-bold shadow-lg transition-all">
                    Entendido
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let orders = JSON.parse(localStorage.getItem('sys_orders')) || [];
        let reminders = JSON.parse(localStorage.getItem('sys_reminders')) || [];
        let statuses = JSON.parse(localStorage.getItem('sys_statuses')) || [
            { id: 'entregue', label: 'Entregue', color: 'emerald', icon: 'fa-check', isSystem: true },
            { id: 'aguardando', label: 'Aguardando', color: 'amber', icon: 'fa-clock', isSystem: true },
            { id: 'assinatura', label: 'Assinatura', color: 'indigo', icon: 'fa-file-signature', isSystem: true }
        ];
        let services = JSON.parse(localStorage.getItem('sys_services')) || [];

        let pendingDeleteId = null;
        let pendingDeleteType = null; 
        let statusChartInstance = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check data integrity
            if (!Array.isArray(orders)) orders = [];
            if (!Array.isArray(reminders)) reminders = [];
            if (!Array.isArray(statuses)) statuses = [];
            if (!Array.isArray(services)) services = [];

            // Initialize all views
            renderOrders();
            renderReminders();
            renderStatuses();
            renderServices();
            updateDashboard();
            updateServicesDashboard();
            updateDateTime();
            populateStatusSelects();
            
            // Check notifications permission
            if (Notification.permission === "granted") {
                checkReminders();
                checkDeliveries(); 
            } else if (Notification.permission !== "denied") {
                const dot = document.getElementById('notification-dot');
                if(dot) dot.classList.remove('hidden');
            }

            // Periodic updates
            setInterval(updateDateTime, 60000); 
            setInterval(() => {
                checkReminders();
                checkDeliveries(); 
            }, 60000); 
        });

        // --- TOAST SYSTEM ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            // Define colors
            let bgClass, iconClass, icon;
            if (type === 'error') {
                bgClass = 'bg-white border-l-4 border-red-500 text-slate-800';
                iconClass = 'text-red-500';
                icon = 'fa-circle-xmark';
            } else if (type === 'success') {
                bgClass = 'bg-white border-l-4 border-green-500 text-slate-800';
                iconClass = 'text-green-500';
                icon = 'fa-circle-check';
            } else {
                bgClass = 'bg-white border-l-4 border-blue-500 text-slate-800';
                iconClass = 'text-blue-500';
                icon = 'fa-circle-info';
            }

            toast.className = `toast-enter p-4 rounded-lg shadow-lg flex items-center gap-3 w-80 pointer-events-auto transform transition-all duration-300 ${bgClass}`;
            toast.innerHTML = `
                <i class="fa-solid ${icon} ${iconClass} text-xl"></i>
                <p class="font-medium text-sm">${message}</p>
            `;

            container.appendChild(toast);

            // Remove automatically
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // --- NOTIFICATIONS ---
        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    const dot = document.getElementById('notification-dot');
                    if(dot) dot.classList.add('hidden');
                    new Notification("SysCompras", { body: "Notificações ativadas com sucesso!" });
                    showToast('Notificações ativadas!', 'success');
                    checkReminders();
                    checkDeliveries();
                } else {
                    alert("Para receber alertas, você precisa permitir notificações nas configurações do navegador.");
                }
            });
        }

        function checkReminders() {
            if (Notification.permission !== "granted") return;
            
            const today = new Date().toISOString().split('T')[0];
            let changed = false;
            
            reminders.forEach(r => {
                if (!r.done && r.date === today && !r.notified) {
                    new Notification("Lembrete SysCompras", {
                        body: r.text,
                        icon: "https://cdn-icons-png.flaticon.com/512/1792/1792931.png"
                    });
                    r.notified = true; 
                    changed = true;
                }
            });
            if(changed) saveData();
        }

        function checkDeliveries() {
            const hasSystemPermission = Notification.permission === "granted";
            const today = new Date().toISOString().split('T')[0];
            let changed = false;
            let deliveriesToday = [];

            orders.forEach(o => {
                if (o.status !== 'entregue' && o.date === today && !o.notified) {
                    deliveriesToday.push(o);
                    if (hasSystemPermission) {
                        new Notification("Entrega Hoje!", {
                            body: `${o.supplier} - ${o.product}`,
                            icon: "https://cdn-icons-png.flaticon.com/512/2942/2942838.png"
                        });
                    }
                    o.notified = true; 
                    changed = true;
                }
            });

            if (deliveriesToday.length > 0) {
                showNotificationModal(deliveriesToday);
            }

            if(changed) saveData();
        }

        function showNotificationModal(items) {
            const list = document.getElementById('notification-list');
            if(!list) return;
            
            list.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = "flex items-start gap-3 pb-3 border-b border-slate-200 last:border-0 last:pb-0";
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-xs font-bold text-slate-500 shrink-0">
                        ${item.supplier.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <p class="font-bold text-slate-700 text-sm leading-tight">${item.supplier}</p>
                        <p class="text-xs text-slate-500">${item.product}</p>
                        <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full mt-1 inline-block">${item.sector || 'Geral'}</span>
                    </div>
                `;
                list.appendChild(div);
            });
            
            openModal('modal-notification');
        }

        // --- CLOCK & GREETING ---
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
            const dateString = now.toLocaleDateString('pt-BR', dateOptions);
            const bannerDate = document.getElementById('banner-date');
            if(bannerDate) bannerDate.innerText = dateString.charAt(0).toUpperCase() + dateString.slice(1);
            const shortDateOptions = { day: 'numeric', month: 'numeric', year: 'numeric' };
            const headerDate = document.getElementById('header-date');
            if(headerDate) headerDate.innerText = now.toLocaleDateString('pt-BR', shortDateOptions);
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            const headerTime = document.getElementById('header-time');
            if(headerTime) headerTime.innerText = now.toLocaleTimeString('pt-BR', timeOptions);
            const hour = now.getHours();
            let greeting = 'Bom dia';
            if (hour >= 12 && hour < 18) greeting = 'Boa tarde';
            else if (hour >= 18) greeting = 'Boa noite';
            const welcome = document.getElementById('welcome-msg');
            if(welcome) welcome.innerText = `${greeting}, Admin`;
        }

        // --- LOGIN & LOGOUT ---
        function attemptLogin(e) {
            e.preventDefault();
            const pass = document.getElementById('login-password').value;
            const errorMsg = document.getElementById('login-error');
            
            if(pass === '1234') {
                document.getElementById('login-screen').classList.add('hidden');
                // Removed toast here
            } else {
                errorMsg.classList.remove('hidden');
                setTimeout(() => errorMsg.classList.add('hidden'), 3000);
                showToast('Senha incorreta. Tente novamente.', 'error');
            }
        }
        function logout() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-password').value = '';
            showToast('Sessão encerrada.', 'info');
        }

        // --- DATA PERSISTENCE ---
        function saveData() {
            localStorage.setItem('sys_orders', JSON.stringify(orders));
            localStorage.setItem('sys_reminders', JSON.stringify(reminders));
            localStorage.setItem('sys_statuses', JSON.stringify(statuses));
            localStorage.setItem('sys_services', JSON.stringify(services));
            updateDashboard();
            updateServicesDashboard();
        }

        function exportData() {
            const data = {
                orders: orders,
                reminders: reminders,
                statuses: statuses,
                services: services,
                timestamp: new Date().toISOString()
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_syscompras_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Backup exportado com sucesso!', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsedData = JSON.parse(e.target.result);
                    if (parsedData.orders || parsedData.services) {
                        if(confirm('Isso substituirá todos os dados atuais. Deseja continuar?')) {
                            orders = parsedData.orders || [];
                            reminders = parsedData.reminders || [];
                            statuses = parsedData.statuses || statuses;
                            services = parsedData.services || [];
                            saveData();
                            showToast('Dados restaurados com sucesso!', 'success');
                            setTimeout(() => location.reload(), 1000);
                        }
                    } else {
                        showToast('Arquivo de backup inválido.', 'error');
                    }
                } catch (error) {
                    showToast('Erro ao ler arquivo.', 'error');
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // --- STATUS LOGIC ---
        function newStatus() {
            document.getElementById('form-status').reset();
            document.getElementById('status-id').value = '';
            openModal('modal-status');
        }

        function saveStatus(e) {
            e.preventDefault();
            const id = document.getElementById('status-id').value;
            const label = document.getElementById('status-label').value;
            const color = document.getElementById('status-color').value;
            const icon = document.getElementById('status-icon').value;

            if (id) {
                const index = statuses.findIndex(s => s.id === id);
                if(index > -1) {
                    statuses[index] = { ...statuses[index], label, color, icon };
                }
            } else {
                let newId = label.toLowerCase().replace(/\s+/g, '-');
                if(statuses.find(s => s.id === newId)) newId += '-' + Date.now();
                statuses.push({ id: newId, label, color, icon, isSystem: false });
            }

            saveData();
            closeModal('modal-status');
            renderStatuses();
            populateStatusSelects(); 
            updateDashboard(); 
            renderOrders(); 
            showToast('Status salvo com sucesso!', 'success');
        }

        function deleteStatus(id) {
            const status = statuses.find(s => s.id === id);
            if(status && status.isSystem) {
                showToast('Este status é padrão e não pode ser excluído.', 'error');
                return;
            }
            pendingDeleteId = id;
            pendingDeleteType = 'status';
            openModal('modal-delete');
        }

        function editStatus(id) {
            const status = statuses.find(s => s.id === id);
            if(!status) return;

            document.getElementById('status-id').value = status.id;
            document.getElementById('status-label').value = status.label;
            document.getElementById('status-color').value = status.color;
            document.getElementById('status-icon').value = status.icon;
            openModal('modal-status');
        }

        function moveStatus(id, direction) {
            const index = statuses.findIndex(s => s.id === id);
            if (index < 0) return;

            const newIndex = index + direction;

            if (newIndex >= 0 && newIndex < statuses.length) {
                const temp = statuses[index];
                statuses[index] = statuses[newIndex];
                statuses[newIndex] = temp;
                
                saveData();
                renderStatuses();
                populateStatusSelects();
                updateDashboard();
                showToast('Ordem atualizada.', 'info');
            }
        }

        function renderStatuses() {
            const tbody = document.getElementById('status-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';

            statuses.forEach((s, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0";
                const badgeClass = `bg-${s.color}-100 text-${s.color}-700`;
                
                const isFirst = index === 0;
                const isLast = index === statuses.length - 1;
                const disableUp = isFirst ? 'opacity-30 cursor-not-allowed' : 'hover:bg-slate-100 hover:text-slate-800';
                const disableDown = isLast ? 'opacity-30 cursor-not-allowed' : 'hover:bg-slate-100 hover:text-slate-800';

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-700">
                        ${s.label} 
                        ${s.isSystem ? '<i class="fa-solid fa-lock text-xs text-slate-300 ml-2" title="Sistema"></i>' : ''}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${badgeClass}">${s.color}</span>
                    </td>
                    <td class="px-6 py-4 text-center text-slate-500"><i class="fa-solid ${s.icon}"></i></td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-1">
                            <button onclick="moveStatus('${s.id}', -1)" class="text-slate-400 p-2 rounded transition-colors ${disableUp}" title="Mover para cima" ${isFirst ? 'disabled' : ''}>
                                <i class="fa-solid fa-arrow-up"></i>
                            </button>
                            <button onclick="moveStatus('${s.id}', 1)" class="text-slate-400 p-2 rounded transition-colors ${disableDown} mr-2" title="Mover para baixo" ${isLast ? 'disabled' : ''}>
                                <i class="fa-solid fa-arrow-down"></i>
                            </button>
                            <div class="h-4 w-px bg-slate-200 mx-1"></div>
                            <button onclick="editStatus('${s.id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded transition-colors" title="Editar">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            ${!s.isSystem ? `<button onclick="deleteStatus('${s.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition-colors" title="Excluir"><i class="fa-solid fa-trash"></i></button>` : '<div class="w-8"></div>'}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function populateStatusSelects() {
            const selects = [document.getElementById('order-status'), document.getElementById('filter-status')];
            selects.forEach(sel => {
                if(!sel) return;
                const currentVal = sel.value; 
                sel.innerHTML = '';
                
                if(sel.id === 'filter-status') {
                    const allOpt = document.createElement('option');
                    allOpt.value = 'all';
                    allOpt.text = 'Todos os Status';
                    sel.appendChild(allOpt);
                }

                statuses.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.text = s.label;
                    sel.appendChild(opt);
                });

                if(currentVal && (currentVal === 'all' || statuses.find(s => s.id === currentVal))) {
                    sel.value = currentVal;
                }
            });
        }

        // --- ORDER LOGIC ---
        function newOrder() {
            document.getElementById('form-order').reset();
            document.getElementById('order-id').value = '';
            document.getElementById('modal-title').innerText = 'Nova Ordem';
            document.getElementById('btn-save-order').innerText = 'Salvar Ordem';
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('order-creation-time').value = timeStr;
            
            if(statuses.length > 0) document.getElementById('order-status').value = statuses[0].id;
            
            openModal('modal-order');
        }

        function saveOrder(e) {
            e.preventDefault();
            const id = document.getElementById('order-id').value;
            const dateInput = document.getElementById('order-date').value;
            
            if(!dateInput) {
                showToast('Selecione uma data válida!', 'error');
                return;
            }

            const orderData = {
                id: id ? parseInt(id) : Date.now(),
                number: document.getElementById('order-num').value,
                creationTime: document.getElementById('order-creation-time').value, 
                supplier: document.getElementById('order-supplier').value,
                sector: document.getElementById('order-sector').value, 
                product: document.getElementById('order-product').value,
                date: dateInput,
                status: document.getElementById('order-status').value,
                timestamp: Date.now()
            };

            if (id) {
                const index = orders.findIndex(o => o.id == id);
                if (index > -1) {
                    const originalCreationTime = orders[index].creationTime;
                    orders[index] = orderData; 
                    if(originalCreationTime) orders[index].creationTime = originalCreationTime; 
                    orders[index].timestamp = Date.now();
                    showToast('Ordem atualizada com sucesso!', 'success');
                }
            } else {
                orders.push(orderData);
                showToast('Nova ordem criada!', 'success');
            }

            saveData();
            closeModal('modal-order');
            renderOrders();
        }

        function deleteOrder(id) {
            pendingDeleteId = id;
            pendingDeleteType = 'order';
            openModal('modal-delete');
        }

        // --- SERVICES LOGIC (NOVA) ---
        function newService() {
            document.getElementById('form-service').reset();
            document.getElementById('service-id').value = '';
            
            // Auto-fill dates with today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('service-date').value = today;
            document.getElementById('service-report-date').value = today;
            
            document.getElementById('modal-service-title').innerText = 'Novo Serviço';
            openModal('modal-service');
        }

        function saveService(e) {
            e.preventDefault();
            const idValue = document.getElementById('service-id').value;
            
            const serviceData = {
                id: idValue ? parseInt(idValue) : Date.now(),
                provider: document.getElementById('service-provider').value,
                type: document.getElementById('service-type').value,
                cost: 0, 
                date: document.getElementById('service-date').value,
                reportDate: document.getElementById('service-report-date').value,
                status: document.getElementById('service-status').value,
                desc: document.getElementById('service-desc').value,
                timestamp: Date.now()
            };

            if (idValue) {
                const numId = parseInt(idValue);
                const index = services.findIndex(s => s.id === numId);
                
                if(index > -1) {
                    services[index] = serviceData;
                    showToast('Serviço atualizado!', 'success');
                } else {
                    services.push(serviceData);
                    showToast('Novo serviço criado (fallback)!', 'info');
                }
            } else {
                services.push(serviceData);
                showToast('Serviço adicionado!', 'success');
            }

            saveData();
            closeModal('modal-service');
            renderServices();
            updateServicesDashboard();
        }

        function deleteService(id) {
            pendingDeleteId = id;
            pendingDeleteType = 'service';
            openModal('modal-delete');
        }

        // NOVA FUNÇÃO PARA ATUALIZAR STATUS DO SERVIÇO
        function updateServiceStatus(id, newStatus) {
            const index = services.findIndex(s => s.id === id);
            if (index > -1) {
                services[index].status = newStatus;
                saveData();
                renderServices(); 
                updateServicesDashboard(); 
                showToast('Status do serviço atualizado!', 'info');
            }
        }

        function editService(id) {
            const service = services.find(s => s.id === id);
            if(!service) return;

            document.getElementById('service-id').value = service.id;
            document.getElementById('service-provider').value = service.provider;
            document.getElementById('service-type').value = service.type;
            document.getElementById('service-date').value = service.date;
            document.getElementById('service-report-date').value = service.reportDate || service.date; // Fallback
            document.getElementById('service-status').value = service.status;
            document.getElementById('service-desc').value = service.desc || '';

            document.getElementById('modal-service-title').innerText = 'Editar Serviço';
            openModal('modal-service');
        }

        function renderServices() {
            const grid = document.getElementById('services-grid');
            if(!grid) return;
            grid.innerHTML = '';

            const search = document.getElementById('search-service').value.toLowerCase();
            const filter = document.getElementById('filter-service-status').value;
            const filterDate = document.getElementById('filter-service-date').value;

            const filtered = services.filter(s => {
                const matchesSearch = s.provider.toLowerCase().includes(search) || s.type.toLowerCase().includes(search);
                const matchesFilter = filter === 'all' || s.status === filter;
                // Filter by Service Date (Data de Realização)
                const matchesDate = !filterDate || s.date === filterDate;
                
                return matchesSearch && matchesFilter && matchesDate;
            });

            const emptyState = document.getElementById('services-empty-state');
            if(filtered.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                
                filtered.forEach(s => {
                    let statusColor = 'bg-gray-100 text-gray-600';
                    let statusIcon = 'fa-clock';
                    
                    let dateDisplay = '';
                    if (s.status === 'agendado') {
                         dateDisplay = `<span class="text-blue-600"><i class="fa-regular fa-calendar-days mr-1"></i> Agendado: ${formatDate(s.date)}</span>`;
                    } else {
                         dateDisplay = `<span class="text-slate-500"><i class="fa-regular fa-calendar-check mr-1"></i> Data: ${formatDate(s.date)}</span>`;
                    }

                    if(s.status === 'concluido') { statusColor = 'bg-green-100 text-green-700'; statusIcon = 'fa-check'; }
                    if(s.status === 'pendente') { statusColor = 'bg-amber-100 text-amber-700'; statusIcon = 'fa-spinner'; }
                    if(s.status === 'agendado') { statusColor = 'bg-blue-100 text-blue-700'; statusIcon = 'fa-calendar'; }

                    const options = [
                        {val: 'agendado', label: 'Agendado'},
                        {val: 'pendente', label: 'Pendente'},
                        {val: 'concluido', label: 'Concluído'}
                    ].map(opt => `<option value="${opt.val}" ${s.status === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('');

                    const card = document.createElement('div');
                    card.className = "bg-white rounded-2xl p-6 shadow-sm border border-slate-100 hover:shadow-md transition-shadow group relative";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-brand-50 text-brand-600 flex items-center justify-center font-bold text-sm">
                                    ${s.provider.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-lg">${s.provider}</h4>
                                    <p class="text-xs font-medium mt-0.5">${dateDisplay}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editService(${s.id})" class="text-slate-400 hover:text-brand-600 p-1 transition-colors"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteService(${s.id})" class="text-slate-400 hover:text-red-500 p-1 transition-colors"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        
                        <div class="space-y-3 mb-4">
                            <div>
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Serviço</p>
                                <p class="text-sm font-medium text-slate-700">${s.type}</p>
                            </div>
                            ${s.desc ? `<div><p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Descrição</p><p class="text-sm text-slate-600 line-clamp-2">${s.desc}</p></div>` : ''}
                        </div>

                        <div class="flex justify-end items-center pt-4 border-t border-slate-50">
                            <div class="relative group/select">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <i class="fa-solid ${statusIcon} ${statusColor.split(' ')[1]}"></i>
                                </div>
                                <select onchange="updateServiceStatus(${s.id}, this.value)" 
                                        class="appearance-none pl-9 pr-8 py-1.5 rounded-full text-xs font-bold uppercase cursor-pointer focus:outline-none transition-colors ${statusColor} hover:brightness-95">
                                    ${options}
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <i class="fa-solid fa-chevron-down text-[10px] opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }
        }

        function updateServicesDashboard() {
            const dash = document.getElementById('services-dashboard');
            if(!dash) return;
            dash.innerHTML = '';

            const completedCount = services.filter(s => s.status === 'concluido').length;
            const pendingCount = services.filter(s => s.status !== 'concluido').length;

            const cards = [
                { label: 'Serviços Realizados', value: completedCount, icon: 'fa-check-double', color: 'blue' },
                { label: 'Pendentes / Agendados', value: pendingCount, icon: 'fa-clock', color: 'amber' }
            ];

            cards.forEach(c => {
                const div = document.createElement('div');
                div.className = "bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between";
                div.innerHTML = `
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${c.label}</p>
                        <h3 class="text-2xl font-bold text-slate-800">${c.value}</h3>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-${c.color}-50 text-${c.color}-600 flex items-center justify-center text-xl">
                        <i class="fa-solid ${c.icon}"></i>
                    </div>
                `;
                dash.appendChild(div);
            });
        }

        // --- PRINT SERVICES ---
        function printServices() {
            const search = document.getElementById('search-service').value.toLowerCase();
            const filter = document.getElementById('filter-service-status').value;
            const filterDate = document.getElementById('filter-service-date').value;

            const filtered = services.filter(s => {
                const matchesSearch = s.provider.toLowerCase().includes(search) || s.type.toLowerCase().includes(search);
                const matchesFilter = filter === 'all' || s.status === filter;
                const matchesDate = !filterDate || s.date === filterDate;
                return matchesSearch && matchesFilter && matchesDate;
            });

            if (filtered.length === 0) {
                showToast('Não há dados para imprimir com os filtros atuais.', 'error');
                return;
            }

            const printWindow = window.open('', '', 'height=800,width=1000');
            const now = new Date().toLocaleString('pt-BR');
            const dateLabel = filterDate ? formatDate(filterDate) : 'Todas';
            
            const total = filtered.length;
            const concluidos = filtered.filter(s => s.status === 'concluido').length;
            const pendentes = filtered.filter(s => s.status !== 'concluido').length;

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <title>Relatório de Serviços - SysCompras</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        @media print {
                            @page { margin: 1cm; size: A4; }
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                        
                        body {
                            font-family: 'Inter', sans-serif;
                            color: #1e293b;
                            line-height: 1.5;
                            margin: 0;
                            padding: 2rem;
                            background: #fff;
                        }

                        .header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 3rem;
                            padding-bottom: 1.5rem;
                            border-bottom: 2px solid #f1f5f9;
                        }

                        .brand {
                            display: flex;
                            align-items: center;
                            gap: 0.75rem;
                        }

                        .brand-icon {
                            width: 40px;
                            height: 40px;
                            background-color: #0ea5e9;
                            color: white;
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 1.25rem;
                            font-weight: bold;
                            font-family: sans-serif; 
                        }

                        .brand-name {
                            font-size: 1.25rem;
                            font-weight: 700;
                            color: #0f172a;
                            letter-spacing: -0.025em;
                        }

                        .report-info {
                            text-align: right;
                        }

                        .report-title {
                            font-size: 0.875rem;
                            text-transform: uppercase;
                            letter-spacing: 0.05em;
                            color: #64748b;
                            font-weight: 600;
                            margin: 0 0 0.25rem 0;
                        }

                        .report-date {
                            font-size: 0.875rem;
                            color: #0f172a;
                            font-weight: 500;
                        }

                        .filter-context {
                            font-size: 0.75rem;
                            color: #64748b;
                            margin-bottom: 1.5rem;
                            padding: 0.75rem;
                            background-color: #f8fafc;
                            border-radius: 0.5rem;
                            border: 1px solid #e2e8f0;
                        }

                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 2rem;
                        }

                        th {
                            text-align: left;
                            font-size: 0.75rem;
                            text-transform: uppercase;
                            letter-spacing: 0.05em;
                            font-weight: 600;
                            color: #64748b;
                            padding: 0.75rem 1rem;
                            background-color: #f8fafc;
                            border-bottom: 1px solid #e2e8f0;
                        }

                        td {
                            padding: 1rem;
                            font-size: 0.875rem;
                            border-bottom: 1px solid #f1f5f9;
                            vertical-align: top;
                        }

                        tr:last-child td {
                            border-bottom: none;
                        }

                        .provider {
                            font-weight: 600;
                            color: #0f172a;
                            display: block;
                            margin-bottom: 0.125rem;
                        }
                        
                        .service-type {
                            color: #64748b;
                            font-size: 0.8rem;
                        }

                        .badge {
                            display: inline-block;
                            padding: 0.25rem 0.75rem;
                            border-radius: 9999px;
                            font-size: 0.7rem;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.025em;
                        }

                        .badge-concluido { background-color: #dcfce7; color: #166534; }
                        .badge-pendente { background-color: #fef3c7; color: #92400e; }
                        .badge-agendado { background-color: #dbeafe; color: #1e40af; }

                        .footer {
                            margin-top: 4rem;
                            padding-top: 1rem;
                            border-top: 1px solid #f1f5f9;
                            display: flex;
                            justify-content: space-between;
                            font-size: 0.75rem;
                            color: #94a3b8;
                        }
                        
                        .summary {
                            display: flex;
                            gap: 3rem;
                            margin-top: 2rem;
                            padding: 1.5rem;
                            background-color: #f8fafc;
                            border-radius: 0.75rem;
                            border: 1px solid #f1f5f9;
                        }
                        
                        .summary-item label {
                            display: block;
                            font-size: 0.7rem;
                            text-transform: uppercase;
                            font-weight: 600;
                            letter-spacing: 0.05em;
                            color: #64748b;
                            margin-bottom: 0.25rem;
                        }
                        
                        .summary-item value {
                            display: block;
                            font-size: 1.25rem;
                            font-weight: 700;
                            color: #0f172a;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="brand">
                            <div class="brand-icon">S</div>
                            <div class="brand-name">SysCompras Pro</div>
                        </div>
                        <div class="report-info">
                            <h1 class="report-title">Relatório de Serviços</h1>
                            <div class="report-date">Data do Filtro: ${dateLabel}</div>
                            <div class="report-date">Emitido em: ${now}</div>
                        </div>
                    </div>

                    ${filter !== 'all' ? `<div class="filter-context">Filtro aplicado: Status <strong>${filter.toUpperCase()}</strong></div>` : ''}

                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%">Prestador / Serviço</th>
                                <th style="width: 15%">Data Realização</th>
                                <th style="width: 15%">Status</th>
                                <th style="width: 40%">Descrição</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(s => `
                                <tr>
                                    <td>
                                        <span class="provider">${s.provider}</span>
                                        <span class="service-type">${s.type}</span>
                                    </td>
                                    <td>${formatDate(s.date)}</td>
                                    <td><span class="badge badge-${s.status}">${s.status}</span></td>
                                    <td style="color: #475569;">${s.desc || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="summary">
                        <div class="summary-item">
                            <label>Total de Registros</label>
                            <value>${total}</value>
                        </div>
                        <div class="summary-item">
                            <label>Concluídos</label>
                            <value>${concluidos}</value>
                        </div>
                         <div class="summary-item">
                            <label>Pendentes/Agendados</label>
                            <value>${pendentes}</value>
                        </div>
                    </div>

                    <div class="footer">
                        <span>Documento gerado automaticamente pelo sistema.</span>
                        <span>Página 1 de 1</span>
                    </div>

                    <script>
                        // Auto print when loaded
                        window.onload = function() { 
                            setTimeout(function() { 
                                window.print(); 
                                // Optional: window.close(); 
                            }, 500); 
                        }
                    <\/script>
                </body>
                </html>
            `;

            printWindow.document.write(htmlContent);
            printWindow.document.close();
        }

        // --- GENERIC CONFIRM DELETE ---
        function confirmDelete() {
            if (pendingDeleteId) {
                if(pendingDeleteType === 'order') {
                    orders = orders.filter(o => o.id !== pendingDeleteId);
                    showToast('Ordem excluída.', 'success');
                    renderOrders();
                    updateDashboard();
                } else if (pendingDeleteType === 'reminder') {
                    reminders = reminders.filter(r => r.id !== pendingDeleteId);
                    showToast('Lembrete removido.', 'success');
                    renderReminders();
                    updateDashboard();
                } else if (pendingDeleteType === 'status') {
                    statuses = statuses.filter(s => s.id !== pendingDeleteId);
                    populateStatusSelects();
                    renderStatuses();
                    updateDashboard();
                    showToast('Status excluído.', 'success');
                } else if (pendingDeleteType === 'service') {
                    services = services.filter(s => s.id !== pendingDeleteId);
                    renderServices();
                    updateServicesDashboard();
                    showToast('Serviço excluído.', 'success');
                }
                saveData();
                pendingDeleteId = null;
                pendingDeleteType = null;
            }
            closeModal('modal-delete');
        }

        // --- FILTER & UTILS ---
        function filterOrders() {
            renderOrders();
        }

        function updateOrderStatus(id, newStatus) {
            const orderIndex = orders.findIndex(o => o.id === id);
            if (orderIndex > -1) {
                orders[orderIndex].status = newStatus;
                saveData(); 
                renderOrders(); 
                showToast('Status atualizado!', 'info');
            }
        }

        function getStatusConfig(statusId) {
            const s = statuses.find(item => item.id === statusId) || { color: 'slate' };
            return {
                textClass: `text-${s.color}-600`,
                dotClass: `bg-${s.color}-500`,
                bgClass: `bg-${s.color}-500`
            };
        }

        function renderOrders() {
            const searchInput = document.getElementById('search-order');
            const filterInput = document.getElementById('filter-status');
            
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            const filter = filterInput ? filterInput.value : 'all';
            
            const desktopBody = document.getElementById('orders-desktop-body');
            const mobileGrid = document.getElementById('orders-mobile-grid');
            
            if(desktopBody) desktopBody.innerHTML = '';
            if(mobileGrid) mobileGrid.innerHTML = '';

            const filtered = orders.filter(o => {
                const matchesSearch = o.supplier.toLowerCase().includes(search) || 
                                      o.product.toLowerCase().includes(search) ||
                                      (o.sector && o.sector.toLowerCase().includes(search));
                const matchesFilter = filter === 'all' || o.status === filter;
                return matchesSearch && matchesFilter;
            });

            const emptyState = document.getElementById('empty-state');
            if (filtered.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden');
            } else {
                if(emptyState) emptyState.classList.add('hidden');
                
                filtered.forEach(o => {
                    const statusConfig = getStatusConfig(o.status);
                    const initial = o.supplier.charAt(0).toUpperCase();
                    const timeDisplay = o.creationTime ? `<span class="block text-[10px] text-slate-400 mt-0.5 font-normal">Criado às ${o.creationTime}</span>` : '';
                    
                    let optionsHtml = '';
                    statuses.forEach(s => {
                        optionsHtml += `<option value="${s.id}" ${o.status === s.id ? 'selected' : ''}>${s.label}</option>`;
                    });

                    // --- DESKTOP ROW ---
                    if (desktopBody) {
                        const tr = document.createElement('tr');
                        tr.className = "bg-white shadow-sm rounded-xl hover:shadow-md transition-shadow group";
                        tr.innerHTML = `
                            <td class="p-4 pl-6 first:rounded-l-xl font-semibold text-slate-700 text-center align-middle">
                                <div class="flex flex-col items-center justify-center">
                                    <span><span class="text-slate-400 mr-1">#</span>${o.number}</span>
                                    ${timeDisplay}
                                </div>
                            </td>
                            <td class="p-4 align-middle">
                                <div class="flex items-center justify-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold flex items-center justify-center text-xs border border-slate-200">
                                        ${initial}
                                    </div>
                                    <span class="font-medium text-slate-700">${o.supplier}</span>
                                </div>
                            </td>
                            <td class="p-4 text-slate-600 font-medium text-center align-middle">${o.sector || '-'}</td>
                            <td class="p-4 text-slate-600 font-medium text-center align-middle">${o.product}</td>
                            <td class="p-4 text-slate-500 text-sm text-center align-middle">
                                <div class="flex items-center justify-center">
                                    <i class="fa-regular fa-calendar mr-2 text-slate-300"></i>${formatDate(o.date)}
                                </div>
                            </td>
                            <td class="p-4 text-center align-middle">
                                <div class="relative inline-block w-full max-w-[140px] mx-auto">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
                                        <div class="w-2 h-2 rounded-full ${statusConfig.dotClass}"></div>
                                    </div>
                                    <select onchange="updateOrderStatus(${o.id}, this.value)" 
                                            class="w-full appearance-none pl-6 py-1.5 pr-8 rounded-lg text-xs font-bold border border-transparent hover:bg-slate-50 focus:outline-none cursor-pointer transition-all ${statusConfig.textClass}">
                                        ${optionsHtml}
                                    </select>
                                </div>
                            </td>
                            <td class="p-4 pr-6 text-right align-middle last:rounded-r-xl">
                                <div class="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="editOrder(${o.id})" class="w-8 h-8 rounded-lg text-slate-400 hover:text-brand-600 hover:bg-brand-50 transition-colors" title="Editar"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="deleteOrder(${o.id})" class="w-8 h-8 rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 transition-colors" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        `;
                        desktopBody.appendChild(tr);
                    }

                    // --- MOBILE CARD ---
                    if (mobileGrid) {
                        const card = document.createElement('div');
                        card.className = "bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col gap-4";
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-slate-50 text-slate-600 font-bold flex items-center justify-center border border-slate-100">
                                        ${initial}
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800 leading-tight">${o.supplier}</h4>
                                        <span class="text-xs text-slate-400 font-medium">#${o.number} ${o.creationTime ? ' • ' + o.creationTime : ''}</span>
                                    </div>
                                </div>
                                <div class="relative">
                                    <select onchange="updateOrderStatus(${o.id}, this.value)" 
                                            class="appearance-none pl-3 py-1 pr-6 rounded-lg text-xs font-bold border border-slate-100 bg-slate-50 focus:outline-none cursor-pointer ${statusConfig.textClass}">
                                        ${optionsHtml}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="bg-slate-50 p-2 rounded-lg">
                                    <p class="text-xs text-slate-400 uppercase font-bold mb-1">Setor</p>
                                    <p class="text-slate-700 font-medium truncate">${o.sector || '-'}</p>
                                </div>
                                <div class="bg-slate-50 p-2 rounded-lg">
                                    <p class="text-xs text-slate-400 uppercase font-bold mb-1">Entrega</p>
                                    <p class="text-slate-700 font-medium">${formatDate(o.date)}</p>
                                </div>
                                <div class="bg-slate-50 p-2 rounded-lg col-span-2">
                                    <p class="text-xs text-slate-400 uppercase font-bold mb-1">Produto</p>
                                    <p class="text-slate-700 font-medium truncate">${o.product}</p>
                                </div>
                            </div>

                            <div class="flex justify-end gap-2 border-t border-slate-50 pt-3">
                                <button onclick="editOrder(${o.id})" class="text-xs font-bold text-slate-500 hover:text-brand-600 px-3 py-2 rounded-lg hover:bg-slate-50">EDITAR</button>
                                <button onclick="deleteOrder(${o.id})" class="text-xs font-bold text-slate-500 hover:text-red-500 px-3 py-2 rounded-lg hover:bg-slate-50">EXCLUIR</button>
                            </div>
                        `;
                        mobileGrid.appendChild(card);
                    }
                });
            }
        }

        // --- REMINDER LOGIC ---
        function saveReminder(e) {
            e.preventDefault();
            const text = document.getElementById('reminder-text').value;
            const date = document.getElementById('reminder-date').value;

            reminders.push({
                id: Date.now(),
                text,
                date,
                done: false,
                notified: false 
            });

            saveData();
            closeModal('modal-reminder');
            renderReminders();
            checkReminders(); 
            showToast('Lembrete criado!', 'success');
        }

        function deleteReminder(id) {
            reminders = reminders.filter(r => r.id !== id);
            saveData();
            renderReminders();
        }

        function toggleReminder(id) {
            const r = reminders.find(item => item.id === id);
            if(r) r.done = !r.done;
            saveData();
            renderReminders();
        }

        function renderReminders() {
            const grid = document.getElementById('reminders-grid');
            if (grid) grid.innerHTML = '';
            
            const dashboardList = document.getElementById('dashboard-reminders-list');
            if (dashboardList) dashboardList.innerHTML = '';

            const emptyState = document.getElementById('reminders-empty');
            
            if(reminders.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden');
                if(dashboardList) {
                    dashboardList.innerHTML = `
                        <div class="flex flex-col items-center justify-center text-slate-400 h-full py-8">
                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3">
                                <i class="fa-solid fa-mug-hot text-2xl text-slate-300"></i>
                            </div>
                            <p class="text-sm font-medium">Tudo tranquilo por aqui!</p>
                            <p class="text-xs opacity-60">Nenhum lembrete pendente.</p>
                        </div>
                    `;
                }
            } else {
                if(emptyState) emptyState.classList.add('hidden');
                
                reminders.forEach(r => {
                    // Render in Reminders Page
                    if (grid) {
                        const div = document.createElement('div');
                        div.className = "bg-purple-50 rounded-lg p-3 border border-purple-100 flex items-start gap-3";
                        div.innerHTML = `
                             <button onclick="toggleReminder(${r.id})" class="mt-1 flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${r.done ? 'bg-purple-400 border-purple-400 text-white' : 'border-slate-300 text-transparent hover:border-purple-400'}">
                                <i class="fa-solid fa-check text-xs"></i>
                            </button>
                             <div class="flex-1">
                                <p class="text-sm font-medium text-slate-700 leading-snug line-clamp-2 ${r.done ? 'line-through text-slate-400' : ''}">${r.text}</p>
                                ${r.date ? `<p class="text-[10px] text-purple-600/70 font-bold mt-1">${formatDate(r.date)}</p>` : ''}
                             </div>
                             <button onclick="deleteReminder(${r.id})" class="text-slate-300 hover:text-red-400 transition-colors"><i class="fa-solid fa-times"></i></button>
                        `;
                        grid.appendChild(div);
                    }
                });

                // Render in Dashboard (Top 3 Pending)
                if (dashboardList) {
                    const pendingReminders = reminders.filter(r => !r.done).slice(0, 3);
                    if (pendingReminders.length > 0) {
                        pendingReminders.forEach(r => {
                            const div = document.createElement('div');
                            div.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-[0_2px_8px_rgba(0,0,0,0.02)] group hover:border-purple-200 hover:shadow-md transition-all cursor-pointer";
                            div.onclick = () => showPage('reminders');
                            div.innerHTML = `
                                     <div class="flex items-start gap-3">
                                         <div class="w-8 h-8 rounded-lg bg-purple-50 text-purple-500 flex items-center justify-center flex-shrink-0 group-hover:bg-purple-500 group-hover:text-white transition-colors">
                                            <i class="fa-solid fa-thumbtack text-xs"></i>
                                         </div>
                                         <div class="flex-1 min-w-0">
                                            <p class="text-sm font-semibold text-slate-700 leading-tight group-hover:text-purple-700 transition-colors line-clamp-2">${r.text}</p>
                                            ${r.date ? `<p class="text-[10px] text-slate-400 mt-1 font-medium"><i class="fa-regular fa-clock mr-1"></i>${formatDate(r.date)}</p>` : ''}
                                         </div>
                                     </div>
                            `;
                            dashboardList.appendChild(div);
                        });
                    } else {
                        dashboardList.innerHTML = `
                            <div class="flex flex-col items-center justify-center text-slate-400 h-full py-8">
                                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3">
                                    <i class="fa-solid fa-mug-hot text-2xl text-slate-300"></i>
                                </div>
                                <p class="text-sm font-medium">Tudo tranquilo por aqui!</p>
                                <p class="text-xs opacity-60">Nenhum lembrete pendente.</p>
                            </div>
                        `;
                    }
                }
            }
        }

        // --- DASHBOARD LOGIC ---
        function updateDashboard() {
            // 1. Calculate counts
            const counts = {};
            statuses.forEach(s => counts[s.id] = 0);
            orders.forEach(o => {
                if(counts[o.status] !== undefined) counts[o.status]++;
            });

            const total = orders.length;
            const safeTotal = total > 0 ? total : 1;

            // 2. Dynamic Cards
            const kpiGrid = document.getElementById('kpi-grid');
            if (kpiGrid) {
                kpiGrid.innerHTML = '';
                
                statuses.forEach(s => {
                    const count = counts[s.id];
                    const percent = Math.round((count / safeTotal) * 100);
                    
                    const div = document.createElement('div');
                    div.className = "bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group";
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-xs font-bold text-${s.color}-600/70 uppercase tracking-wider">${s.label}</p>
                                <h3 class="text-3xl font-extrabold text-slate-800 mt-1">${count}</h3>
                            </div>
                            <div class="w-10 h-10 rounded-xl bg-${s.color}-50 text-${s.color}-600 flex items-center justify-center text-lg group-hover:scale-110 transition-transform">
                                <i class="fa-solid ${s.icon}"></i>
                            </div>
                        </div>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mb-2">
                            <div class="h-full bg-${s.color}-500 rounded-full" style="width: ${percent}%"></div>
                        </div>
                        <p class="text-xs text-slate-400 text-right">${percent}% do total</p>
                    `;
                    kpiGrid.appendChild(div);
                });

                // Add Lembretes Card
                const pendingRemindersCount = reminders.filter(r => !r.done).length;
                const remDiv = document.createElement('div');
                remDiv.className = "bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group";
                remDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs font-bold text-purple-600/70 uppercase tracking-wider">Lembretes Ativos</p>
                            <h3 class="text-3xl font-extrabold text-slate-800 mt-1">${pendingRemindersCount}</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center text-lg group-hover:scale-110 transition-transform">
                            <i class="fa-regular fa-bell"></i>
                        </div>
                    </div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mb-2">
                        <div class="h-full bg-purple-500 rounded-full w-full opacity-50"></div>
                    </div>
                    <p class="text-xs text-slate-400 flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Sistema Operacional
                    </p>
                `;
                kpiGrid.appendChild(remDiv);
            }

            // 3. Update Chart
            const ctx = document.getElementById('statusChart');
            if (ctx) {
                const labels = statuses.map(s => s.label);
                const data = statuses.map(s => counts[s.id]);
                
                const colorMap = {
                    emerald: '#10b981', amber: '#f59e0b', indigo: '#6366f1',
                    slate: '#64748b', red: '#ef4444', orange: '#f97316',
                    green: '#22c55e', teal: '#14b8a6', cyan: '#06b6d4',
                    sky: '#0ea5e9', blue: '#3b82f6', violet: '#8b5cf6',
                    purple: '#a855f7', fuchsia: '#d946ef', pink: '#ec4899', rose: '#f43f5e'
                };

                const chartColors = statuses.map(s => colorMap[s.color] || '#64748b');

                if (statusChartInstance) {
                    statusChartInstance.data.labels = labels;
                    statusChartInstance.data.datasets[0].data = data;
                    statusChartInstance.data.datasets[0].backgroundColor = chartColors;
                    statusChartInstance.data.datasets[0].borderColor = chartColors;
                    statusChartInstance.update();
                } else {
                    const ctx2d = ctx.getContext('2d');
                    statusChartInstance = new Chart(ctx2d, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Quantidade',
                                data: data,
                                backgroundColor: chartColors,
                                borderColor: chartColors,
                                borderWidth: 0,
                                borderRadius: 8, 
                                borderSkipped: false,
                                barThickness: 40,
                                maxBarThickness: 50
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    titleColor: '#f8fafc',
                                    bodyColor: '#f8fafc',
                                    padding: 14,
                                    cornerRadius: 12,
                                    displayColors: true,
                                    usePointStyle: true,
                                    callbacks: { title: () => '' }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    grid: { color: '#f1f5f9', drawBorder: false },
                                    ticks: { font: { family: "'Inter', sans-serif", size: 11 }, color: '#94a3b8' },
                                    border: { display: false }
                                },
                                y: {
                                    grid: { display: false, drawBorder: false },
                                    ticks: { font: { family: "'Inter', sans-serif", size: 11, weight: '600' }, color: '#64748b' },
                                    border: { display: false }
                                }
                            }
                        }
                    });
                }
            }

            // 4. Upcoming Deliveries
            const upcomingBody = document.getElementById('upcoming-deliveries-body');
            if (upcomingBody) {
                upcomingBody.innerHTML = '';
                
                const today = new Date();
                today.setHours(0,0,0,0);
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);

                const upcomingOrders = orders.filter(o => {
                    if(!o.date) return false;
                    const [y, m, d] = o.date.split('-').map(Number);
                    const orderDate = new Date(y, m - 1, d); 
                    return orderDate >= today && orderDate <= nextWeek && o.status !== 'entregue';
                }).sort((a,b) => new Date(a.date) - new Date(b.date));

                if(upcomingOrders.length > 0) {
                    document.getElementById('upcoming-empty').classList.add('hidden');
                    upcomingOrders.slice(0, 5).forEach(o => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50 transition-colors group cursor-default border-b border-slate-50 last:border-0";
                        const initial = o.supplier.charAt(0).toUpperCase();
                        
                        const [y, m, d] = o.date.split('-').map(Number);
                        const orderDate = new Date(y, m - 1, d);
                        const diffTime = Math.abs(orderDate - today);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        const daysLabel = diffDays === 0 ? 'Hoje' : (diffDays === 1 ? 'Amanhã' : `Em ${diffDays} dias`);
                        const daysClass = diffDays <= 2 ? 'text-red-500 bg-red-50' : 'text-blue-500 bg-blue-50';

                        tr.innerHTML = `
                            <td class="px-8 py-5 pl-8">
                                <div class="flex flex-col">
                                    <span class="font-bold text-slate-700 text-sm">${formatDate(o.date)}</span>
                                    <span class="text-[10px] font-bold uppercase mt-1 px-2 py-0.5 rounded-md w-fit ${daysClass}">${daysLabel}</span>
                                </div>
                            </td>
                            <td class="px-8 py-5">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-white border border-slate-100 text-slate-500 font-bold flex items-center justify-center text-sm shadow-sm">
                                        ${initial}
                                    </div>
                                    <div>
                                        <p class="font-bold text-slate-700 text-sm">${o.supplier}</p>
                                        <p class="text-xs text-slate-400 mt-0.5 max-w-[200px] truncate" title="${o.product}">${o.product}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-8 py-5 text-right">
                                <span class="text-xs font-medium text-slate-500 bg-slate-100 px-3 py-1 rounded-full">${o.sector || 'Geral'}</span>
                            </td>
                        `;
                        upcomingBody.appendChild(tr);
                    });
                } else {
                    document.getElementById('upcoming-empty').classList.remove('hidden');
                }
            }
        }

        // --- UTILS ---
        function formatDate(dateString) {
            if(!dateString) return '';
            const [y, m, d] = dateString.split('-');
            return `${d}/${m}/${y}`;
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const obj = document.getElementById(id);
            if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // --- MODAL UTILS ---
        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
            if(id === 'modal-reminder') document.getElementById('form-reminder').reset();
            // Removed automated reset for status and service to allow editing
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            if (id === 'modal-delete') {
                pendingDeleteId = null;
                pendingDeleteType = null;
            }
        }

        // --- NAVIGATION ---
        function toggleSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        function showPage(pageId) {
            ['dashboard', 'orders', 'reminders', 'settings', 'status', 'services'].forEach(id => {
                const page = document.getElementById(`page-${id}`);
                if (page) page.classList.add('hidden');
                
                const navBtn = document.getElementById(`nav-${id}`);
                if(navBtn) {
                    if (id === pageId) {
                        navBtn.classList.add('bg-slate-50', 'text-brand-600', 'border-brand-200');
                        navBtn.classList.remove('text-slate-600', 'border-transparent');
                    } else {
                        navBtn.classList.remove('bg-slate-50', 'text-brand-600', 'border-brand-200');
                        navBtn.classList.add('text-slate-600', 'border-transparent');
                    }
                }
            });

            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) targetPage.classList.remove('hidden');
            
            if (pageId === 'dashboard') updateDashboard();
        }

    </script>
</body>
</html>
